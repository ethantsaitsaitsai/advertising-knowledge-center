version: '3.8'

services:
  backend:
    build: .
    # 直接使用 python 執行，不透過 uv run，減少記憶體開銷
    command: python backend/server.py
    ports:
      - "8002:8000"
    env_file: .env
    volumes:
      - ./ssh_keys:/root/.ssh:ro
    deploy:
      resources:
        limits:
          cpus: '0.50'        # 限制最多使用 50% CPU
          memory: 384M        # 硬限制 384MB RAM
        reservations:
          memory: 128M        # 保證至少有 128MB
    restart: always

  frontend:
    build: .
    # 直接使用 chainlit 執行
    command: chainlit run frontend/ui.py --port 8001 --host 0.0.0.0
    ports:
      - "8001:8001"
    environment:
      - LANGSERVE_URL=http://backend:8000/agent
    env_file: .env
    depends_on:
      - backend
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 384M
        reservations:
          memory: 128M
    restart: always