# SQL Template 索引與元數據
# Agent 可根據意圖關鍵字自動選擇合適的 templates

templates:
  id_finder:
    file: id_finder.sql
    description: 核心 ID 搜尋器。根據時間、客戶、格式等條件，找出所有相關的 IDs (CueList, Campaign, Plaid)。
    keywords:
      - 搜尋
      - 查找
      - ID
      - 關聯
    merge_key: N/A
    returns:
      - cue_list_id
      - campaign_id
      - plaid
    required_params:
      - start_date
      - end_date
    optional_params:
      - client_ids
      - agency_ids
      - ad_format_type_ids
      - industry_ids
      - sub_industry_ids
      - product_line_ids
    priority: 1
    dependencies: []
    notes: 這是所有詳細查詢的前置步驟，用於獲取 IDs。

  campaign_basic:
    file: campaign_basic.sql
    description: 活動基本資訊（客戶、活動名稱、日期、Agency）。附帶 Plaid 列表。
    keywords:
      - 基本資訊
      - 活動名稱
      - 客戶
      - 代理商
      - 走期
      - 日期
    merge_key: campaign_id
    returns:
      - campaign_id
      - client_name
      - brand
      - contract_name
      - campaign_name
      - start_date
      - end_date
      - agency_name
      - plaids
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - id_finder

  targeting_segments:
    file: targeting_segments.sql
    description: 數據鎖定 / 受眾標籤設定 (基於版位)
    keywords:
      - 數據鎖定
      - 受眾
      - 標籤
      - TA
      - 目標客群
      - Segment
      - 鎖定條件
    merge_key: plaid
    returns:
      - plaid
      - segment_name
      - segment_code
      - segment_category
    required_params:
      - plaids
    optional_params: []
    priority: 2
    dependencies:
      - id_finder
    notes: 基於 Plaid 查詢，最為精準。

  investment_budget:
    file: investment_budget.sql
    description: 進單金額/投資金額（委刊有記錄且成功拋轉）
    keywords:
      - 進單金額
      - 投資金額
      - 投資量
      - 委刊預算
      - 合約預算
      - 應收帳款
    merge_key: cue_list_id
    returns:
      - cue_list_id
      - campaign_id
      - format_name
      - investment_amount
    required_params:
      - cue_list_ids
    optional_params: []
    priority: 2
    dependencies:
      - id_finder
    notes: 格式層級明細，來自 cue_list_budgets.budget，過濾 status IN ('converted', 'requested')

  execution_budget:
    file: execution_budget.sql
    description: 執行金額/認列金額（執行中或已結案）
    keywords:
      - 執行金額
      - 認列金額
      - 營收認列
      - 實際執行
      - 消耗預算
    merge_key: plaid
    returns:
      - plaid
      - execution_amount
      - execution_gift
      - execution_start_date
      - execution_end_date
    required_params:
      - plaids
    optional_params: []
    priority: 2
    dependencies:
      - id_finder
    notes: 執行單層級明細，來自 pre_campaign.budget，過濾 status IN ('oncue', 'close')

  unified_performance:
    file: unified_performance.sql
    description: 核心成效查詢 (ClickHouse View)，支援產品線、產業、格式等多維度分析 (ID Driven)
    keywords:
      - 成效
      - 產品線
      - 點擊
      - CTR
      - 產業成效
      - 格式成效
    merge_key: N/A
    returns:
      - dimensions (dynamic)
      - clicks
      - effective_impressions
      - ctr
      - cmpid
      - plaid
    required_params:
      - start_date
      - end_date
    optional_params:
      - client_ids
      - product_line_ids
      - ad_format_type_ids
      - one_categories
      - one_sub_categories
      - plaids
      - cmpids
    priority: 1
    dependencies:
      - id_finder
    notes: 高效能查詢，使用 ID 進行精準過濾。

  unified_dimensions:
    file: unified_dimensions.sql
    description: 維度探索查詢 (ClickHouse View)，查詢有哪些產品線、格式、版位 (不含成效)
    keywords:
      - 有哪些
      - 產品線清單
      - 格式清單
      - 版位清單
      - 媒體清單
    merge_key: N/A
    returns:
      - dimensions (dynamic)
    required_params:
      - start_date
      - end_date
      - dimensions
    optional_params:
      - client_ids
      - product_line_ids
      - one_categories
    priority: 1
    dependencies: []
    notes: 用於「List」類型的問題，速度快且支援產品線。

# 使用範例組合 (Use Case Combinations)
use_cases:
  client_analysis:
    description: 特定客戶分析 (預算、成效、受眾)
    templates:
      - id_finder
      - investment_budget
      - unified_performance
      - targeting_segments

  industry_analysis:
    description: 產業/市場分析 (預算佔比)
    templates:
      - id_finder
      - investment_budget
      - unified_performance

  dimension_discovery:
    description: 維度探索 (有哪些產品線/格式)
    templates:
      - unified_dimensions

# Agent 選擇邏輯建議
selection_rules:
  - rule: 查詢特定實體 (客戶/活動/產業)
    action: 優先使用 id_finder 取得 IDs
  - rule: 查詢包含「成效」、「點擊」、「CTR」
    action: 使用 unified_performance (傳入 plaids)
  - rule: 查詢包含「預算」、「進單」
    action: 使用 investment_budget (傳入 cue_list_ids)
  - rule: 查詢包含「執行」、「花費」
    action: 使用 execution_budget (傳入 plaids)
  - rule: 查詢包含「數據鎖定」、「受眾」
    action: 使用 targeting_segments (傳入 plaids)

# 範例查詢對應
example_queries:
  - query: "Nike 的跑鞋產品線成效如何？"
    selected_templates:
      - id_finder
      - unified_performance
    reasoning: |
      - 1. id_finder (取得 IDs)
      - 2. unified_performance (用 IDs 查成效)

  - query: "悠遊卡投遞的格式、成效、數據鎖定，格式投資金額"
    selected_templates:
      - id_finder
      - investment_budget
      - unified_performance
      - targeting_segments
    reasoning: |
      - 1. id_finder (取得相關 IDs)
      - 2. investment_budget (用 cue_list_ids 查預算)
      - 3. unified_performance (用 plaids 查成效)
      - 4. targeting_segments (用 plaids 查受眾)

  - query: "汽車產業的格式預算佔比如何？"
    selected_templates:
      - id_finder
      - investment_budget
    reasoning: |
      - 1. resolve_entity (取得產業 ID)
      - 2. id_finder (取得該產業 ID 的相關 IDs)
      - 3. investment_budget (查金額)

