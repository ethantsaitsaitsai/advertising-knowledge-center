# SQL Template 索引與元數據
# Agent 可根據意圖關鍵字自動選擇合適的 templates

templates:
  campaign_basic:
    file: campaign_basic.sql
    description: 活動基本資訊（客戶、活動名稱、日期、預算）
    keywords:
      - 基本資訊
      - 活動名稱
      - 客戶
      - 代理商
      - 走期
      - 日期
    merge_key: campaign_id
    returns:
      - campaign_id
      - client_name
      - brand
      - contract_name
      - campaign_name
      - start_date
      - end_date
      - agency_name
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 1  # 通常是必選
    dependencies: []

  ad_formats:
    file: ad_formats.sql
    description: 廣告格式明細（從合約層級）
    keywords:
      - 格式
      - 廣告形式
      - 平台
      - Banner
    merge_key: campaign_id
    returns:
      - campaign_id
      - format_name
      - format_type_id
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic  # 建議先執行 campaign_basic 取得 campaign_ids

  targeting_segments:
    file: targeting_segments.sql
    description: 數據鎖定 / 受眾標籤設定
    keywords:
      - 數據鎖定
      - 受眾
      - 標籤
      - TA
      - 目標客群
      - Segment
      - 鎖定條件
    merge_key: campaign_id
    returns:
      - campaign_id
      - placement_id
      - medianame
      - segment_name
      - segment_code
      - segment_category
      - data_source
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: 一個 campaign 可能有多個受眾標籤，merge 後需要 groupby 聚合

  media_placements:
    file: media_placements.sql
    description: 投放媒體與版位明細（執行層級）
    keywords:
      - 媒體
      - 版位
      - Placement
      - 投放位置
      - 媒體名稱
      - 廣告版位
    merge_key: campaign_id
    secondary_key: placement_id
    returns:
      - campaign_id
      - placement_detail_id
      - placement_id
      - ad_format_name
      - video_seconds
      - budget
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: L4 層級資料，一個 campaign 對應多個 placements

  investment_budget:
    file: investment_budget.sql
    description: 進單金額/投資金額（委刊有記錄且成功拋轉）
    keywords:
      - 進單金額
      - 投資金額
      - 投資量
      - 委刊預算
      - 合約預算
      - 應收帳款
    merge_key: campaign_id
    returns:
      - campaign_id
      - format_name
      - format_type_id
      - investment_amount
      - client_name
      - agency_name
      - investment_start_date
      - investment_end_date
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 2
    dependencies:
      - campaign_basic
    notes: 格式層級明細，來自 cue_list_budgets.budget，過濾 status IN ('converted', 'requested')

  execution_budget:
    file: execution_budget.sql
    description: 執行金額/認列金額（執行中或已結案）
    keywords:
      - 執行金額
      - 認列金額
      - 營收認列
      - 實際執行
      - 消耗預算
    merge_key: campaign_id
    returns:
      - campaign_id
      - execution_id
      - client_name
      - agency_name
      - execution_amount
      - execution_gift
      - execution_start_date
      - execution_end_date
      - booked_at
      - closed_at
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 2
    dependencies:
      - campaign_basic
    notes: 執行單層級明細，來自 pre_campaign.budget，過濾 status IN ('oncue', 'close')

  budget_details:
    file: budget_details.sql
    description: 預算摘要（整合投資金額與執行金額的總覽）
    keywords:
      - 預算摘要
      - 預算總覽
      - 投資執行對比
      - Budget
    merge_key: campaign_id
    returns:
      - campaign_id
      - contract_total_budget
      - campaign_budget
      - total_investment_amount
      - total_investment_gift
      - total_execution_amount
      - total_execution_gift
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: 包含 L1/L2/L3 三個層級的預算，注意不可直接加總

# 使用範例組合 (Use Case Combinations)
use_cases:
  basic_overview:
    description: 活動基本概覽
    templates:
      - campaign_basic
      - budget_details

  format_analysis:
    description: 格式分析（格式 + 投資金額）
    templates:
      - campaign_basic
      - ad_formats
      - budget_details

  targeting_analysis:
    description: 數據鎖定分析
    templates:
      - campaign_basic
      - targeting_segments

  media_distribution:
    description: 媒體分布分析
    templates:
      - campaign_basic
      - media_placements
      - budget_details

  comprehensive_report:
    description: 完整報告（所有維度）
    templates:
      - campaign_basic
      - ad_formats
      - targeting_segments
      - media_placements
      - budget_details

# Agent 選擇邏輯建議
selection_rules:
  - rule: 如果查詢包含「格式」關鍵字
    action: 選擇 ad_formats
  - rule: 如果查詢包含「數據鎖定」、「受眾」、「TA」
    action: 選擇 targeting_segments
  - rule: 如果查詢包含「預算」、「投資」、「金額」、「花費」
    action: 選擇 budget_details
  - rule: 如果查詢包含「媒體」、「版位」、「Placement」
    action: 選擇 media_placements
  - rule: 預設情況（無明確關鍵字）
    action: 至少選擇 campaign_basic

# 範例查詢對應
example_queries:
  - query: "悠遊卡投遞的格式、成效、數據鎖定，格式投資金額"
    selected_templates:
      - campaign_basic
      - ad_formats
      - targeting_segments
      - budget_details
    reasoning: |
      - "格式" → ad_formats
      - "數據鎖定" → targeting_segments
      - "投資金額" → budget_details
      - campaign_basic 作為基礎

  - query: "悠遊卡投放在哪些媒體，各媒體的預算？"
    selected_templates:
      - campaign_basic
      - media_placements
    reasoning: |
      - "媒體" → media_placements
      - "預算" → media_placements 已包含 budget 欄位
      - campaign_basic 作為基礎

  - query: "悠遊卡的受眾標籤有哪些？規模多大？"
    selected_templates:
      - campaign_basic
      - targeting_segments
    reasoning: |
      - "受眾標籤" → targeting_segments