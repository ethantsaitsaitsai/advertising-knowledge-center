# SQL Template 索引與元數據
# Agent 可根據意圖關鍵字自動選擇合適的 templates

templates:
  campaign_basic:
    file: campaign_basic.sql
    description: 活動基本資訊（客戶、活動名稱、日期、預算）
    keywords:
      - 基本資訊
      - 活動名稱
      - 客戶
      - 代理商
      - 走期
      - 日期
    merge_key: campaign_id
    returns:
      - campaign_id
      - client_name
      - brand
      - contract_name
      - campaign_name
      - start_date
      - end_date
      - agency_name
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 1  # 通常是必選
    dependencies: []

  ad_formats:
    file: ad_formats.sql
    description: 廣告格式明細（從合約層級）
    keywords:
      - 格式
      - 廣告形式
      - 平台
      - Banner
    merge_key: campaign_id
    returns:
      - campaign_id
      - format_name
      - format_type_id
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic  # 建議先執行 campaign_basic 取得 campaign_ids

  targeting_segments:
    file: targeting_segments.sql
    description: 數據鎖定 / 受眾標籤設定
    keywords:
      - 數據鎖定
      - 受眾
      - 標籤
      - TA
      - 目標客群
      - Segment
      - 鎖定條件
    merge_key: campaign_id
    returns:
      - campaign_id
      - placement_id
      - medianame
      - segment_name
      - segment_code
      - segment_category
      - data_source
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: 一個 campaign 可能有多個受眾標籤，merge 後需要 groupby 聚合

  media_placements:
    file: media_placements.sql
    description: 投放媒體與版位明細（執行層級）
    keywords:
      - 媒體
      - 版位
      - Placement
      - 投放位置
      - 媒體名稱
      - 廣告版位
    merge_key: campaign_id
    secondary_key: placement_id
    returns:
      - campaign_id
      - placement_detail_id
      - placement_id
      - ad_format_name
      - video_seconds
      - budget
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: L4 層級資料，一個 campaign 對應多個 placements

  investment_budget:
    file: investment_budget.sql
    description: 進單金額/投資金額（委刊有記錄且成功拋轉）
    keywords:
      - 進單金額
      - 投資金額
      - 投資量
      - 委刊預算
      - 合約預算
      - 應收帳款
    merge_key: campaign_id
    returns:
      - campaign_id
      - format_name
      - format_type_id
      - investment_amount
      - client_name
      - agency_name
      - investment_start_date
      - investment_end_date
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 2
    dependencies:
      - campaign_basic
    notes: 格式層級明細，來自 cue_list_budgets.budget，過濾 status IN ('converted', 'requested')

  execution_budget:
    file: execution_budget.sql
    description: 執行金額/認列金額（執行中或已結案）
    keywords:
      - 執行金額
      - 認列金額
      - 營收認列
      - 實際執行
      - 消耗預算
    merge_key: campaign_id
    returns:
      - campaign_id
      - execution_id
      - client_name
      - agency_name
      - execution_amount
      - execution_gift
      - execution_start_date
      - execution_end_date
      - booked_at
      - closed_at
    required_params: []
    optional_params:
      - campaign_ids
      - client_names
      - start_date
      - end_date
    priority: 2
    dependencies:
      - campaign_basic
    notes: 執行單層級明細，來自 pre_campaign.budget，過濾 status IN ('oncue', 'close')

  budget_details:
    file: budget_details.sql
    description: 預算摘要（整合投資金額與執行金額的總覽）
    keywords:
      - 預算摘要
      - 預算總覽
      - 投資執行對比
      - Budget
    merge_key: campaign_id
    returns:
      - campaign_id
      - contract_total_budget
      - campaign_budget
      - total_investment_amount
      - total_investment_gift
      - total_execution_amount
      - total_execution_gift
    required_params:
      - campaign_ids
    optional_params: []
    priority: 2
    dependencies:
      - campaign_basic
    notes: 包含 L1/L2/L3 三個層級的預算，注意不可直接加總
    
  industry_format_budget:
    file: industry_format_budget.sql
    description: 產業/客戶層級的格式預算佔比統計
    keywords:
      - 產業預算
      - 格式預算佔比
      - 產業分析
      - 格式花費
    merge_key: dimension_name
    returns:
      - dimension_name
      - format_name
      - total_budget
      - campaign_count
    required_params: []
    optional_params:
      - industry_ids
      - sub_industry_ids
      - client_ids
      - start_date
      - end_date
    priority: 1
    dependencies: []
    notes: 聚合層級資料，非 Campaign 明細

  format_benchmark:
    file: format_benchmark.sql
    description: 格式成效基準 (Benchmark) 與排名
    keywords:
      - 格式成效
      - 格式排名
      - CTR排名
      - VTR排名
      - 基準值
      - Benchmark
    merge_key: format_name
    returns:
      - format_name
      - format_id
      - avg_ctr
      - avg_vtr
      - avg_er
      - total_impressions
    required_params:
      - start_date
      - end_date
    optional_params:
      - cmp_ids
      - format_ids
    priority: 1
    dependencies: []
    notes: ClickHouse 聚合資料，無 Campaign 維度

  unified_performance:
    file: unified_performance.sql
    description: 核心成效查詢 (ClickHouse View)，支援產品線、產業、格式等多維度分析 (ID Driven)
    keywords:
      - 成效
      - 產品線
      - 點擊
      - CTR
      - 產業成效
      - 格式成效
    merge_key: N/A
    returns:
      - dimensions (dynamic)
      - clicks
      - effective_impressions
      - ctr
    required_params:
      - start_date
      - end_date
    optional_params:
      - client_ids
      - product_line_ids
      - ad_format_type_ids
      - one_categories
      - one_sub_categories
      - plaids
      - cmpids
    priority: 1
    dependencies: []
    notes: 高效能查詢，使用 ID 進行精準過濾。

  unified_dimensions:
    file: unified_dimensions.sql
    description: 維度探索查詢 (ClickHouse View)，查詢有哪些產品線、格式、版位 (不含成效)
    keywords:
      - 有哪些
      - 產品線清單
      - 格式清單
      - 版位清單
      - 媒體清單
    merge_key: N/A
    returns:
      - dimensions (dynamic)
    required_params:
      - start_date
      - end_date
      - dimensions
    optional_params:
      - client_ids
      - product_line_ids
      - one_categories
    priority: 1
    dependencies: []
    notes: 用於「List」類型的問題，速度快且支援產品線。

# 使用範例組合 (Use Case Combinations)
use_cases:
  basic_overview:
    description: 活動基本概覽
    templates:
      - campaign_basic
      - budget_details

  dimension_discovery:
    description: 維度探索 (有哪些產品線/格式)
    templates:
      - unified_dimensions

  product_line_performance:
    description: 產品線成效分析
    templates:
      - unified_performance

  format_analysis:
    description: 格式分析（格式 + 投資金額）
    templates:
      - campaign_basic
      - ad_formats
      - budget_details
      - unified_performance # 加入成效

  targeting_analysis:
    description: 數據鎖定分析
    templates:
      - campaign_basic
      - targeting_segments

  media_distribution:
    description: 媒體分布分析
    templates:
      - campaign_basic
      - media_placements
      - budget_details

  comprehensive_report:
    description: 完整報告（所有維度）
    templates:
      - campaign_basic
      - ad_formats
      - targeting_segments
      - media_placements
      - budget_details
      - unified_performance

  industry_analysis:
    description: 產業/市場分析 (預算佔比與格式基準)
    templates:
      - industry_format_budget
      - unified_performance

# Agent 選擇邏輯建議
selection_rules:
  - rule: 如果查詢包含「成效」、「點擊」、「CTR」、「產品線」
    action: 優先選擇 unified_performance
  - rule: 如果查詢包含「格式」關鍵字
    action: 選擇 ad_formats
  - rule: 如果查詢包含「數據鎖定」、「受眾」、「TA」
    action: 選擇 targeting_segments
  - rule: 如果查詢包含「預算」、「投資」、「金額」、「花費」
    action: 選擇 budget_details
  - rule: 如果查詢包含「媒體」、「版位」、「Placement」
    action: 選擇 media_placements
  - rule: 如果查詢包含「佔比」、「排名」、「基準」、「全產業」、「全站」
    action: 選擇 industry_format_budget 或 format_benchmark (視指標而定)
  - rule: 預設情況（無明確關鍵字）
    action: 至少選擇 campaign_basic

# 範例查詢對應
example_queries:
  - query: "Nike 的跑鞋產品線成效如何？"
    selected_templates:
      - unified_performance
    reasoning: |
      - "產品線" + "成效" → unified_performance (group_by=['product_line'])

  - query: "悠遊卡投遞的格式、成效、數據鎖定，格式投資金額"
    selected_templates:
      - campaign_basic
      - ad_formats
      - targeting_segments
      - budget_details
      - unified_performance
    reasoning: |
      - "成效" → unified_performance
      - "格式" → ad_formats
      - "數據鎖定" → targeting_segments
      - "投資金額" → budget_details
      - campaign_basic 作為基礎

  - query: "悠遊卡投放在哪些媒體，各媒體的預算？"
    selected_templates:
      - campaign_basic
      - media_placements
    reasoning: |
      - "媒體" → media_placements
      - "預算" → media_placements 已包含 budget 欄位
      - campaign_basic 作為基礎

  - query: "悠遊卡的受眾標籤有哪些？規模多大？"
    selected_templates:
      - campaign_basic
      - targeting_segments
    reasoning: |
      - "受眾標籤" → targeting_segments

  - query: "汽車產業的格式預算佔比如何？"
    selected_templates:
      - industry_format_budget
    reasoning: |
      - "產業" + "預算佔比" → industry_format_budget

  - query: "半年內所有格式的 CTR 排名？"
    selected_templates:
      - format_benchmark
    reasoning: |
      - "格式" + "排名" + "CTR" → format_benchmark