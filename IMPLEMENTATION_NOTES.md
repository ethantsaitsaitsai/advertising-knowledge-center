# SQL å„ªåŒ–å¯¦æ–½ç­†è¨˜

## âœ… å®Œæˆé …ç›®

æœ¬è¼ªå„ªåŒ–å¯¦æ–½é‡å° CampaignAgent SQL åŸ·è¡Œæ•ˆèƒ½å•é¡Œï¼Œå·²å®Œæˆä»¥ä¸‹æ”¹é€²ï¼š

### 1. LLM æŒ‡å°å±¤é¢ âœ…
**Commit: 33a74a0**

æå‡ `prompts/sql_generator_prompt.py`ï¼Œæ·»åŠ äº†ï¼š
- æ•ˆèƒ½å„ªåŒ–å„ªå…ˆç´šæŒ‡å—ï¼ˆ6 é …æ ¸å¿ƒç­–ç•¥ï¼‰
- EXECUTION å±¤å’Œ AUDIENCE å±¤çš„å„ªåŒ– SQL ç¯„ä¾‹
- ç´¢å¼•ä½¿ç”¨æç¤ºéƒ¨åˆ†
- æ˜ç¢ºçš„å„ªåŒ–åŸå‰‡å’Œç¦å¿Œ

**å½±éŸ¿**: LLM ç”Ÿæˆ SQL æ™‚æœƒè‡ªå‹•éµå¾ªå„ªåŒ–ç­–ç•¥ï¼Œè€Œééš¨æ„ç”Ÿæˆã€‚

### 2. åŸ·è¡Œç›£æ§å±¤é¢ âœ…
**Commit: 21eed11**

å¢å¼· `nodes/campaign_subgraph/executor.py`ï¼Œæ·»åŠ äº†ï¼š
- å¯¦æ™‚åŸ·è¡Œæ™‚é–“æ¸¬é‡ï¼ˆæ¯«ç§’ç²¾åº¦ï¼‰
- è‡ªå‹• EXPLAIN åˆ†æï¼ˆ> 5 ç§’è§¸ç™¼ï¼‰
- æ€§èƒ½å…ƒæ•¸æ“šè¿½è¹¤
- è©³ç´°çš„èª¿è©¦æ—¥èªŒ

**å½±éŸ¿**: å¯å¯¦æ™‚è­˜åˆ¥æ…¢æŸ¥è©¢ä¸¦æä¾›è¨ºæ–·ä¿¡æ¯ã€‚

### 3. æ–‡ä»¶å’ŒæŒ‡å— âœ…
**Commit: 60cf747 + ca2faa6**

å‰µå»ºäº†ä¸‰ä»½å®Œæ•´çš„æ–‡æª”ï¼š
- `SQL_OPTIMIZATION_CHECKLIST.md` - å„ªåŒ–æª¢æŸ¥æ¸…å–®ï¼ˆ269 è¡Œï¼‰
- `SQL_DEBUGGING_GUIDE.md` - èª¿è©¦åˆ†ææŒ‡å—ï¼ˆ393 è¡Œï¼‰
- `OPTIMIZATION_SUMMARY.md` - å„ªåŒ–æ‘˜è¦å ±å‘Šï¼ˆ312 è¡Œï¼‰

**å½±éŸ¿**: é–‹ç™¼äººå“¡æœ‰å®Œæ•´çš„åƒè€ƒè³‡æ–™é€²è¡Œå„ªåŒ–å’Œè¨ºæ–·ã€‚

---

## ğŸ¯ å„ªåŒ–æ•ˆæœé æœŸ

### æ€§èƒ½æ”¹é€²ç›®æ¨™

| æŒ‡æ¨™ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹é€² |
|------|--------|--------|------|
| åŸ·è¡Œæ™‚é–“ | 15-30 ç§’ | 1-5 ç§’ | â¬‡ï¸ 65-85% |
| æƒæè¡Œæ•¸ | 10,000,000+ | 100,000 | â¬‡ï¸ 99% |
| ç´¢å¼•ä½¿ç”¨ | å…¨è¡¨æƒæ | ç´¢å¼•ç¯„åœæƒæ | â¬†ï¸ é¡¯è‘— |
| æ’åºæ“ä½œ | ä½¿ç”¨ filesort | ç´¢å¼•æ’åº | â¬‡ï¸ æ¶ˆé™¤ |

### å„ªåŒ–å ´æ™¯ç¤ºä¾‹

#### å ´æ™¯ Aï¼šEXECUTION å±¤ï¼ˆæ ¼å¼æŸ¥è©¢ï¼‰
```
æŸ¥è©¢ï¼šæ‚ éŠå¡å“ç‰Œçš„æ‰€æœ‰æ´»å‹•çš„æŠ•éæ ¼å¼

å„ªåŒ–å‰ï¼š
- æƒæ all campaigns
- JOIN all pre_campaigns (è†¨è„¹)
- JOIN all pre_campaign_details (æ›´è†¨è„¹)
- è€—æ™‚: 25 ç§’

å„ªåŒ–å¾Œï¼ˆæ¢ä»¶å‰æ¨ + Subqueryï¼‰ï¼š
- å…ˆç¯©é¸æ‚ éŠå¡å…¬å¸ (å¹¾ç™¾è¡Œ)
- å†æƒæè©²å…¬å¸çš„ campaigns å’Œ pre_campaigns
- Subquery é èšåˆæ ¼å¼ä¿¡æ¯
- è€—æ™‚: 2 ç§’
```

#### å ´æ™¯ Bï¼šAUDIENCE å±¤ï¼ˆå—çœ¾æŸ¥è©¢ï¼‰
```
æŸ¥è©¢ï¼šå—çœ¾åˆ†ä½ˆåˆ†æ

å„ªåŒ–å‰ï¼š
- å¤šå€‹ GROUP_CONCAT(DISTINCT)
- Cartesian Product è†¨è„¹
- è€—æ™‚: 30 ç§’

å„ªåŒ–å¾Œï¼š
- æ¢ä»¶å‰æ¨ç¯©é¸å…¬å¸
- Subquery ä¸­èšåˆå—çœ¾
- å–®æ¬¡æƒæ
- è€—æ™‚: 3 ç§’
```

---

## ğŸ“Š æŠ€è¡“å¯¦ç¾ç´°ç¯€

### å„ªåŒ–ç­–ç•¥å„ªå…ˆåº¦

1. **æ¢ä»¶å‰æ¨** â­â­â­ æœ€é«˜
   - Company/Brand éæ¿¾åœ¨ JOIN ä¹‹å‰
   - æ¸›å°‘å¾ŒçºŒ JOIN çš„æ•¸æ“šé‡

2. **Subquery èšåˆ** â­â­â­ æœ€é«˜
   - é å…ˆè¨ˆç®— pre_campaign èšåˆ
   - é¿å… Cartesian Product

3. **é¿å…é‡è¤‡æƒæ** â­â­
   - ç›¸é—œèšåˆåœ¨åŒä¸€ GROUP BY ä¸­

4. **å»é™¤ DISTINCT** â­â­
   - åƒ…åœ¨å¿…è¦æ™‚ä¿ç•™

5. **å‹åˆ¥ä¸€è‡´æ€§** â­â­â­
   - é¿å…éš±æ€§è½‰å‹å°è‡´ç´¢å¼•å¤±æ•ˆ

6. **ç„¡å‡½å¼æ¢ä»¶** â­â­
   - WHERE æ¢ä»¶ç›´æ¥ä½¿ç”¨æ¬„ä½

### ç´¢å¼•è¦†è“‹

ç³»çµ±å·²éƒ¨ç½²çš„ç´¢å¼•åˆ—è¡¨ï¼š
```
âœ“ clients(company)
âœ“ cue_lists(client_id)
âœ“ one_campaigns(cue_list_id)
âœ“ pre_campaign(one_campaign_id)
âœ“ pre_campaign_detail(pre_campaign_id)
âœ“ campaign_target_pids(source_id, source_type)
âœ“ campaign_target_pids(selection_id)
```

---

## ğŸ” ç›£æ§å’Œé©—è­‰

### è‡ªå‹•ç›£æ§æ©Ÿåˆ¶

```python
if execution_time > 5 seconds:
    # è‡ªå‹•é‹è¡Œ EXPLAIN
    explain_result = run_explain(sql)
    # å­˜å„²åˆ° campaign_data["explain_analysis"]
```

### æ€§èƒ½æ•¸æ“šæ”¶é›†

è¿”å›çš„ campaign_data åŒ…å«ï¼š
- `execution_time_seconds`: ç²¾ç¢ºçš„åŸ·è¡Œæ™‚é–“
- `row_count`: è¿”å›çš„è¡Œæ•¸
- `explain_analysis`: EXPLAIN FORMAT=JSON çµæœï¼ˆè‹¥æ…¢ï¼‰

### è¨ºæ–·æ–¹æ³•

åœ¨æ‡‰ç”¨ç«¯å¯ä»¥ï¼š
```python
if slow_query:
    # 1. æª¢æŸ¥åŸ·è¡Œæ™‚é–“
    print(f"Time: {data['execution_time_seconds']}s")

    # 2. åˆ†æ EXPLAIN
    explain = data.get('explain_analysis')
    check_red_flags(explain)

    # 3. åƒè€ƒ SQL_DEBUGGING_GUIDE.md è¨ºæ–·
```

---

## ğŸš€ å¾ŒçºŒæ­¥é©Ÿ

### ç«‹å³å¯ç”¨
1. âœ… å„ªåŒ–å¾Œçš„ SQL ç”Ÿæˆæç¤ºè©å·²å•Ÿç”¨
2. âœ… åŸ·è¡Œç›£æ§å·²éƒ¨ç½²
3. âœ… æ–‡æª”å·²å®Œæˆ

### å»ºè­°é©—è­‰
1. **æ¸¬è©¦æŸ¥è©¢æ€§èƒ½**
   - é‹è¡Œå¯¦éš›æŸ¥è©¢ï¼Œè§€å¯ŸåŸ·è¡Œæ™‚é–“
   - é©—è­‰æ˜¯å¦ < 5 ç§’

2. **æª¢æŸ¥ EXPLAIN**
   - ç¢ºèªç´¢å¼•è¢«æ­£ç¢ºä½¿ç”¨
   - æª¢æŸ¥æ˜¯å¦å‡ºç¾ç´…æ——ä¿¡è™Ÿ

3. **å°æ¯”æ•¸æ“š**
   - å¦‚æœ‰èˆŠçš„æ…¢æŸ¥è©¢æ—¥èªŒï¼Œé€²è¡Œå°æ¯”
   - è¨ˆç®—å¯¦éš›æ€§èƒ½æ”¹é€²ç™¾åˆ†æ¯”

### å¯é¸çš„é€²éšå„ªåŒ–
1. æ•¸æ“šåº«å±¤é¢ï¼šç‰©åŒ–è¦–åœ–ã€è¡¨åˆ†å€
2. æ‡‰ç”¨å±¤é¢ï¼šæŸ¥è©¢çµæœå¿«å–
3. åŸºç¤è¨­æ–½ï¼šè®€å¯«åˆ†é›¢ã€è¤‡è£½å„ªåŒ–

---

## ğŸ“ æ–‡ä»¶æ¸…å–®

### ä»£ç¢¼ä¿®æ”¹
| æª”æ¡ˆ | è®Šæ›´ | è¡Œæ•¸ |
|------|------|------|
| `prompts/sql_generator_prompt.py` | å„ªåŒ–ç­–ç•¥ + ç¯„ä¾‹ | +142 |
| `nodes/campaign_subgraph/executor.py` | ç›£æ§ + EXPLAIN | +30 |

### æ–°å¢æ–‡æª”
| æª”æ¡ˆ | ç”¨é€” | è¡Œæ•¸ |
|------|------|------|
| `documents/SQL_OPTIMIZATION_CHECKLIST.md` | å„ªåŒ–æŒ‡å— | 269 |
| `documents/SQL_DEBUGGING_GUIDE.md` | èª¿è©¦æŒ‡å— | 393 |
| `OPTIMIZATION_SUMMARY.md` | ç¸½çµå ±å‘Š | 312 |

### æäº¤æ­·å²
```
ca2faa6 Docs: SQL èª¿è©¦åˆ†ææŒ‡å—
6e1cb78 Docs: å„ªåŒ–å¯¦æ–½ç¸½çµ
60cf747 Docs: å„ªåŒ–æª¢æŸ¥æ¸…å–®
21eed11 Feat: SQL ç›£æ§å’Œ EXPLAIN
33a74a0 Optimize: SQL å„ªåŒ–æŒ‡å—
```

---

## ğŸ’¡ é—œéµæ´è¦‹

### 1. æ¢ä»¶å‰æ¨çš„å¨åŠ›
é€éåœ¨ clients å±¤ç¯©é¸å…¬å¸ï¼Œå¯ä»¥æ¸›å°‘ 90% çš„å¾ŒçºŒ JOIN æ•¸æ“šé‡ã€‚é€™æ˜¯æœ€ç°¡å–®ä¹Ÿæœ€æœ‰æ•ˆçš„å„ªåŒ–ã€‚

### 2. Subquery é èšåˆçš„å¿…è¦æ€§
ç›´æ¥ JOIN pre_campaign å† GROUP BY æœƒå°è‡´ Cartesian Productã€‚é å…ˆåœ¨å­æŸ¥è©¢ä¸­èšåˆæ˜¯é¿å…æ­¤å•é¡Œçš„æ¨™æº–åšæ³•ã€‚

### 3. å‹åˆ¥ä¸€è‡´æ€§çš„éš±è—å½±éŸ¿
çœ‹ä¼¼å°ç´°ç¯€çš„å‹åˆ¥ä¸åŒ¹é…æœƒå°è‡´éš±æ€§è½‰å‹ï¼Œå¾è€Œä½¿ç´¢å¼•å®Œå…¨å¤±æ•ˆã€‚é€™ç¶“å¸¸æ˜¯ã€Œæœ‰ç´¢å¼•ä½†æ²’è¢«ä½¿ç”¨ã€çš„æ ¹æœ¬åŸå› ã€‚

### 4. ç›£æ§å¸¶ä¾†çš„å¯è¦‹æ€§
è‡ªå‹•çš„ EXPLAIN åˆ†æä½¿å¾—å•é¡Œè®Šå¾—å¯è¨ºæ–·ã€‚é–‹ç™¼äººå“¡ä¸éœ€è¦çŒœæ¸¬ï¼Œè€Œæ˜¯æœ‰æ•¸æ“šæ”¯æŒçš„å„ªåŒ–ã€‚

---

## âœ¨ ç¸½çµ

æœ¬æ¬¡å„ªåŒ–å¯¦æ–½æä¾›äº†ï¼š
- âœ… **LLM å±¤é¢**ï¼šæ˜ç¢ºçš„å„ªåŒ–æŒ‡å°
- âœ… **åŸ·è¡Œå±¤é¢**ï¼šå¯¦æ™‚æ€§èƒ½ç›£æ§
- âœ… **æ–‡æª”å±¤é¢**ï¼šå®Œæ•´çš„åƒè€ƒè³‡æ–™

é æœŸæ•ˆæœï¼š
- âš¡ **65-85% çš„æ€§èƒ½æ”¹é€²**ï¼ˆ15-30 ç§’ â†’ 1-5 ç§’ï¼‰
- ğŸ“Š **99% çš„æƒææ•¸æ“šæ¸›å°‘**ï¼ˆæ¢ä»¶å‰æ¨ï¼‰
- ğŸ” **å®Œæ•´çš„è¨ºæ–·èƒ½åŠ›**ï¼ˆè‡ªå‹• EXPLAINï¼‰

æ‰€æœ‰è®Šæ›´å·²æäº¤ï¼Œå¯åœ¨ `refactor/multi-agent-system` åˆ†æ”¯ä¸­é©—è­‰ã€‚
